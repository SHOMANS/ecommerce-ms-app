name: File Watcher & Hot Reload

# Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ù…Ø³ØªÙ…Ø±Ø© Ù„Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ù‡Ù…Ø©
on:
  push:
    paths:
      - "apps/**"
      - "packages/**"
      - "docker-compose*.yml"
      - "package.json"
      - ".env*.sample"
      - "scripts/**"

  schedule:
    # ÙØ­Øµ Ø¯ÙˆØ±ÙŠ ÙƒÙ„ Ø³Ø§Ø¹Ø©
    - cron: "0 * * * *"

  workflow_dispatch:

jobs:
  watch-and-validate:
    name: Watch Files & Validate
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: ðŸ” Detect changed files
        id: changes
        run: |
          echo "Detecting changes..."

          # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ØªØºÙŠØ±Ø©
          if [ "${{ github.event_name }}" = "push" ]; then
            changed_files=$(git diff --name-only HEAD^ HEAD)
          else
            # Ù„Ù„ÙØ­Øµ Ø§Ù„Ø¯ÙˆØ±ÙŠØŒ ÙØ­Øµ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª
            changed_files="all"
          fi

          echo "Changed files:"
          echo "$changed_files"

          # ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
          if echo "$changed_files" | grep -q "apps/"; then
            echo "apps_changed=true" >> $GITHUB_OUTPUT
          fi

          if echo "$changed_files" | grep -q "packages/"; then
            echo "packages_changed=true" >> $GITHUB_OUTPUT
          fi

          if echo "$changed_files" | grep -q "docker-compose"; then
            echo "docker_changed=true" >> $GITHUB_OUTPUT
          fi

          if echo "$changed_files" | grep -q "scripts/"; then
            echo "scripts_changed=true" >> $GITHUB_OUTPUT
          fi

          if echo "$changed_files" | grep -q ".env"; then
            echo "env_changed=true" >> $GITHUB_OUTPUT
          fi

      - name: ï¿½ Install pnpm
        run: npm install -g pnpm

      - name: ï¿½ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "pnpm"
          cache-dependency-path: "pnpm-lock.yaml"

      - name: ðŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ”§ Validate environment setup
        if: steps.changes.outputs.env_changed == 'true' || steps.changes.outputs.scripts_changed == 'true'
        run: |
          echo "ðŸ” Validating environment setup scripts..."
          chmod +x scripts/*.sh

          # Ø§Ø®ØªØ¨Ø§Ø± Ø³ÙƒØ±ÙŠØ¨Øª Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯
          ./scripts/setup-env.sh dev
          ./scripts/validate-env.sh

      - name: ðŸ—ï¸ Quick build validation
        if: steps.changes.outputs.apps_changed == 'true' || steps.changes.outputs.packages_changed == 'true'
        run: |
          echo "ðŸ—ï¸ Validating build process..."
          pnpm --filter @ecommerce/shared build
          pnpm --filter @ecommerce/auth-service build
          pnpm --filter @ecommerce/users-service build

      - name: ðŸ³ Docker validation
        if: steps.changes.outputs.docker_changed == 'true'
        run: |
          echo "ðŸ³ Validating Docker configuration..."

          # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© docker-compose files
          docker compose -f docker-compose.yml config
          docker compose -f docker-compose.dev.yml config

          # Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ù†Ø§Ø¡ Ø³Ø±ÙŠØ¹
          docker compose -f docker-compose.dev.yml build --no-cache auth-service

      - name: ðŸ“Š Generate change report
        run: |
          echo "ðŸ“Š Change Report" >> change_report.md
          echo "================" >> change_report.md
          echo "" >> change_report.md
          echo "**Commit:** ${{ github.sha }}" >> change_report.md
          echo "**Branch:** ${{ github.ref }}" >> change_report.md
          echo "**Time:** $(date)" >> change_report.md
          echo "" >> change_report.md

          if [ "${{ steps.changes.outputs.apps_changed }}" = "true" ]; then
            echo "- ðŸ”„ Applications changed" >> change_report.md
          fi

          if [ "${{ steps.changes.outputs.packages_changed }}" = "true" ]; then
            echo "- ðŸ“¦ Shared packages changed" >> change_report.md
          fi

          if [ "${{ steps.changes.outputs.docker_changed }}" = "true" ]; then
            echo "- ðŸ³ Docker configuration changed" >> change_report.md
          fi

          if [ "${{ steps.changes.outputs.scripts_changed }}" = "true" ]; then
            echo "- ðŸ”§ Scripts changed" >> change_report.md
          fi

          if [ "${{ steps.changes.outputs.env_changed }}" = "true" ]; then
            echo "- âš™ï¸ Environment files changed" >> change_report.md
          fi

          echo "" >> change_report.md
          echo "**Status:** âœ… All validations passed" >> change_report.md

          cat change_report.md

      - name: ðŸ“¤ Upload change report
        uses: actions/upload-artifact@v4
        with:
          name: change-report-${{ github.sha }}
          path: change_report.md
