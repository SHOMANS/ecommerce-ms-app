name: File Watcher & Hot Reload

# Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ù…Ø³ØªÙ…Ø±Ø© Ù„Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ù‡Ù…Ø©
on:
  push:
    paths:
      - "apps/**"
      - "packages/**"
      - "docker-compose*.yml"
      - "package.json"
      - ".env*.sample"
      - "scripts/**"

  schedule:
    # ÙØ­Øµ Ø¯ÙˆØ±ÙŠ ÙƒÙ„ Ø³Ø§Ø¹Ø©
    - cron: "0 * * * *"

  workflow_dispatch:

jobs:
  watch-and-validate:
    name: Watch Files & Validate
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: ðŸ” Detect changed files
        id: changes
        run: |
          echo "Detecting changes..."

          # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ØªØºÙŠØ±Ø©
          if [ "${{ github.event_name }}" = "push" ]; then
            changed_files=$(git diff --name-only HEAD^ HEAD)
          else
            # Ù„Ù„ÙØ­Øµ Ø§Ù„Ø¯ÙˆØ±ÙŠØŒ ÙØ­Øµ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª
            changed_files="all"
          fi

          echo "Changed files:"
          echo "$changed_files"

          # ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
          if echo "$changed_files" | grep -q "apps/"; then
            echo "apps_changed=true" >> $GITHUB_OUTPUT
          fi

          if echo "$changed_files" | grep -q "packages/"; then
            echo "packages_changed=true" >> $GITHUB_OUTPUT
          fi

          if echo "$changed_files" | grep -q "docker-compose"; then
            echo "docker_changed=true" >> $GITHUB_OUTPUT
          fi

          if echo "$changed_files" | grep -q "scripts/"; then
            echo "scripts_changed=true" >> $GITHUB_OUTPUT
          fi

          if echo "$changed_files" | grep -q ".env"; then
            echo "env_changed=true" >> $GITHUB_OUTPUT
          fi

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: ðŸ“¦ Install dependencies
        run: |
          npm install -g pnpm
          pnpm install --frozen-lockfile

      - name: ðŸ”§ Validate environment setup
        if: steps.changes.outputs.env_changed == 'true' || steps.changes.outputs.scripts_changed == 'true'
        run: |
          echo "ðŸ” Validating environment setup scripts..."
          chmod +x scripts/*.sh

          # Ø§Ø®ØªØ¨Ø§Ø± Ø³ÙƒØ±ÙŠØ¨Øª Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯
          ./scripts/setup-env.sh dev
          ./scripts/validate-env.sh

      - name: ðŸ—ï¸ Quick build test
        if: steps.changes.outputs.apps_changed == 'true' || steps.changes.outputs.packages_changed == 'true'
        run: |
          echo "ðŸ—ï¸ Testing build process..."
          pnpm --filter @ecommerce/shared build
          pnpm --filter @ecommerce/auth-service build
          pnpm --filter @ecommerce/users-service build

      - name: ðŸ³ Docker validation
        if: steps.changes.outputs.docker_changed == 'true'
        run: |
          echo "ðŸ³ Validating Docker configuration..."

          # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© docker-compose files
          docker-compose -f docker-compose.yml config
          docker-compose -f docker-compose.dev.yml config

          # Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ù†Ø§Ø¡ Ø³Ø±ÙŠØ¹
          docker-compose -f docker-compose.dev.yml build --no-cache auth-service

      - name: ðŸ“Š Generate change report
        run: |
          echo "ðŸ“Š Change Report" >> change_report.md
          echo "================" >> change_report.md
          echo "" >> change_report.md
          echo "**Commit:** ${{ github.sha }}" >> change_report.md
          echo "**Branch:** ${{ github.ref }}" >> change_report.md
          echo "**Time:** $(date)" >> change_report.md
          echo "" >> change_report.md

          if [ "${{ steps.changes.outputs.apps_changed }}" = "true" ]; then
            echo "- ðŸ”„ Applications changed" >> change_report.md
          fi

          if [ "${{ steps.changes.outputs.packages_changed }}" = "true" ]; then
            echo "- ðŸ“¦ Shared packages changed" >> change_report.md
          fi

          if [ "${{ steps.changes.outputs.docker_changed }}" = "true" ]; then
            echo "- ðŸ³ Docker configuration changed" >> change_report.md
          fi

          if [ "${{ steps.changes.outputs.scripts_changed }}" = "true" ]; then
            echo "- ðŸ”§ Scripts changed" >> change_report.md
          fi

          if [ "${{ steps.changes.outputs.env_changed }}" = "true" ]; then
            echo "- âš™ï¸ Environment files changed" >> change_report.md
          fi

          echo "" >> change_report.md
          echo "**Status:** âœ… All validations passed" >> change_report.md

          cat change_report.md

      - name: ðŸ“¤ Upload change report
        uses: actions/upload-artifact@v4
        with:
          name: change-report-${{ github.sha }}
          path: change_report.md

  performance-monitor:
    name: Performance Monitoring
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup environment
        run: |
          chmod +x scripts/setup-env.sh
          ./scripts/setup-env.sh dev

      - name: ðŸš€ Start services for monitoring
        run: |
          docker-compose -f docker-compose.dev.yml up -d
          sleep 45

      - name: ðŸ“Š Performance benchmarks
        run: |
          echo "ðŸ“Š Running performance benchmarks..."

          # Ø§Ø®ØªØ¨Ø§Ø± Ø²Ù…Ù† Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©
          echo "ðŸ” Testing response times..."

          # Health check response time
          health_time=$(curl -o /dev/null -s -w '%{time_total}\n' http://localhost:8080/health)
          echo "Health check response time: ${health_time}s"

          # Signup response time
          signup_data='{"email":"perf-test@example.com","password":"test123"}'
          signup_time=$(curl -o /dev/null -s -w '%{time_total}\n' \
            -X POST -H "Content-Type: application/json" \
            -d "$signup_data" http://localhost:8080/auth/signup)
          echo "Signup response time: ${signup_time}s"

          # Signin response time (tests Kafka communication)
          signin_time=$(curl -o /dev/null -s -w '%{time_total}\n' \
            -X POST -H "Content-Type: application/json" \
            -d "$signup_data" http://localhost:8080/auth/signin)
          echo "Signin response time: ${signin_time}s"

          # Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø¯Ø§Ø¡
          echo "ðŸ“Š Performance Report" > performance_report.md
          echo "====================" >> performance_report.md
          echo "" >> performance_report.md
          echo "- Health Check: ${health_time}s" >> performance_report.md
          echo "- User Signup: ${signup_time}s" >> performance_report.md
          echo "- User Signin: ${signin_time}s" >> performance_report.md
          echo "" >> performance_report.md

          # ØªØ­Ø¯ÙŠØ¯ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø£Ø¯Ø§Ø¡ Ù…Ù‚Ø¨ÙˆÙ„
          if (( $(echo "$health_time < 1.0" | bc -l) )) && \
             (( $(echo "$signup_time < 2.0" | bc -l) )) && \
             (( $(echo "$signin_time < 3.0" | bc -l) )); then
            echo "**Status:** âœ… Performance within acceptable limits" >> performance_report.md
          else
            echo "**Status:** âš ï¸ Performance degradation detected" >> performance_report.md
          fi

          cat performance_report.md

      - name: ðŸ§¹ Cleanup
        if: always()
        run: docker-compose -f docker-compose.dev.yml down

      - name: ðŸ“¤ Upload performance report
        uses: actions/upload-artifact@v4
        with:
          name: performance-report-${{ github.sha }}
          path: performance_report.md
