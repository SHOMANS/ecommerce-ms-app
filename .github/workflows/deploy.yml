name: Auto Deploy to EC2

# ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø´Ø± Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ Ù†Ø¬Ø§Ø­ Ø§Ù„Ù€ CI/CD
on:
  workflow_run:
    workflows: ["CI/CD Pipeline"]
    types:
      - completed
    branches: [main]
  
  # ØªØ´ØºÙŠÙ„ ÙŠØ¯ÙˆÙŠ Ù„Ù„Ù†Ø´Ø±
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging

env:
  EC2_HOST: ${{ secrets.EC2_HOST }}
  EC2_USER: ${{ secrets.EC2_USER }}
  EC2_KEY: ${{ secrets.EC2_PRIVATE_KEY }}

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    environment: 
      name: ${{ github.event.inputs.environment || 'production' }}
      url: ${{ vars.DEPLOYMENT_URL }}
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ”§ Setup SSH key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_PRIVATE_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts
        
    - name: ðŸš€ Deploy to EC2
      run: |
        ssh -i ~/.ssh/deploy_key ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'ENDSSH'
          set -e
          
          echo "ðŸ”„ Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù†Ø´Ø±..."
          
          # Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ù…Ø¬Ù„Ø¯ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
          cd ~/ecommerce-ms-app || {
            echo "âŒ Ù…Ø¬Ù„Ø¯ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"
            exit 1
          }
          
          # ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒÙˆØ¯
          echo "ðŸ“¥ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒÙˆØ¯ Ù…Ù† GitHub..."
          git fetch origin
          git reset --hard origin/main
          
          # Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
          echo "â¹ï¸ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©..."
          docker-compose down --remove-orphans || true
          
          # ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù€ images Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
          echo "ðŸ§¹ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù€ images Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©..."
          docker system prune -f || true
          
          # Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ¦Ø© Ù„Ù„Ø¥Ù†ØªØ§Ø¬
          echo "ðŸ”§ Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨ÙŠØ¦Ø© Ø§Ù„Ø¥Ù†ØªØ§Ø¬..."
          chmod +x scripts/setup-env.sh
          ./scripts/setup-env.sh prod
          
          # Ø¨Ù†Ø§Ø¡ ÙˆØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
          echo "ðŸ—ï¸ Ø¨Ù†Ø§Ø¡ ÙˆØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø§Øª..."
          docker-compose up --build -d
          
          # Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ØªØµØ¨Ø­ Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø¬Ø§Ù‡Ø²Ø©
          echo "â³ Ø§Ù†ØªØ¸Ø§Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø§Øª..."
          sleep 60
          
          # Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø®Ø¯Ù…Ø§Øª
          echo "ðŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø®Ø¯Ù…Ø§Øª..."
          if curl -f http://localhost/health; then
            echo "âœ… Ø§Ù„Ù†Ø´Ø± Ù†Ø¬Ø­ - Ø§Ù„Ø®Ø¯Ù…Ø§Øª ØªØ¹Ù…Ù„"
          else
            echo "âŒ Ø§Ù„Ù†Ø´Ø± ÙØ´Ù„ - Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ù„Ø§ ØªØ¹Ù…Ù„"
            docker-compose logs --tail=50
            exit 1
          fi
          
          # Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª
          echo "ðŸ“Š Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª:"
          docker-compose ps
          
          echo "ðŸŽ‰ ØªÙ… Ø§Ù„Ù†Ø´Ø± Ø¨Ù†Ø¬Ø§Ø­!"
        ENDSSH
        
    - name: ðŸ§ª Health Check After Deployment
      run: |
        echo "ðŸ” ÙØ­Øµ ØµØ­Ø© Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ø´Ø±..."
        
        # Ø§Ù†ØªØ¸Ø§Ø± Ø¥Ø¶Ø§ÙÙŠ Ù„Ù„ØªØ£ÙƒØ¯
        sleep 30
        
        # Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ù…Ù† Ø§Ù„Ø®Ø§Ø±Ø¬
        if curl -f http://${{ secrets.EC2_HOST }}/health; then
          echo "âœ… Ø§Ù„Ø®Ø¯Ù…Ø§Øª ØªØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ Ù…Ù† Ø§Ù„Ø®Ø§Ø±Ø¬"
        else
          echo "âŒ Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ù„Ø§ ØªØ¹Ù…Ù„ Ù…Ù† Ø§Ù„Ø®Ø§Ø±Ø¬ - ØªØ­Ù‚Ù‚ Ù…Ù† Security Groups"
          exit 1
        fi
        
    - name: ðŸ“¢ Deployment Notification
      if: always()
      run: |
        if [ $? -eq 0 ]; then
          echo "ðŸŽ‰ ØªÙ… Ø§Ù„Ù†Ø´Ø± Ø¨Ù†Ø¬Ø§Ø­ Ø¥Ù„Ù‰ Ø§Ù„Ø¥Ù†ØªØ§Ø¬!"
          echo "ðŸŒ Ø§Ù„Ù…ÙˆÙ‚Ø¹: http://${{ secrets.EC2_HOST }}"
          echo "â° Ø§Ù„ÙˆÙ‚Øª: $(date)"
          echo "ðŸ“ Commit: ${{ github.sha }}"
        else
          echo "âŒ ÙØ´Ù„ Ø§Ù„Ù†Ø´Ø±!"
          echo "ðŸ”§ ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø³Ø¬Ù„Ø§Øª"
        fi
